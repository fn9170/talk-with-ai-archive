# Docker镜像代理服务搭建指南

## 问题
如何搭建一个docker镜像代理服务，我的目的是解决直接从docker上下载镜像慢的问题

## 问题分析

### 为什么Docker镜像下载慢？
1. **网络延迟**：Docker Hub服务器在海外，访问延迟高
2. **带宽限制**：国际带宽有限制
3. **DNS解析**：DNS解析可能被污染或缓慢
4. **防火墙限制**：某些网络环境有访问限制

### 解决方案概述
1. **使用国内镜像源**（推荐，最简单）
2. **搭建私有Registry代理**（适合企业）
3. **使用CDN加速**（适合大规模部署）
4. **配置Docker Daemon代理**（适合个人）

## 方案一：配置国内镜像源（推荐）

### 1.1 配置Docker Daemon

#### Linux系统配置
```bash
# 创建或编辑Docker配置文件
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json <<-'EOF'
{
  "registry-mirrors": [
    "https://docker.mirrors.ustc.edu.cn",
    "https://hub-mirror.c.163.com",
    "https://mirror.baidubce.com",
    "https://ccr.ccs.tencentyun.com"
  ],
  "insecure-registries": [],
  "debug": false,
  "experimental": false
}
EOF

# 重启Docker服务
sudo systemctl daemon-reload
sudo systemctl restart docker

# 验证配置
docker info | grep -A 10 "Registry Mirrors"
```

#### macOS配置
```bash
# 打开Docker Desktop设置
# Settings -> Docker Engine -> 编辑JSON配置

{
  "builder": {
    "gc": {
      "defaultKeepStorage": "20GB",
      "enabled": true
    }
  },
  "experimental": false,
  "features": {
    "buildkit": true
  },
  "registry-mirrors": [
    "https://docker.mirrors.ustc.edu.cn",
    "https://hub-mirror.c.163.com",
    "https://mirror.baidubce.com"
  ]
}
```

#### Windows配置
```json
// 右键Docker图标 -> Settings -> Docker Engine
{
  "registry-mirrors": [
    "https://docker.mirrors.ustc.edu.cn",
    "https://hub-mirror.c.163.com",
    "https://mirror.baidubce.com"
  ]
}
```

### 1.2 常用国内镜像源

| 提供商 | 镜像地址 | 说明 |
|--------|----------|------|
| 中科大 | https://docker.mirrors.ustc.edu.cn | 稳定可靠 |
| 网易 | https://hub-mirror.c.163.com | 速度快 |
| 百度云 | https://mirror.baidubce.com | 企业级 |
| 腾讯云 | https://ccr.ccs.tencentyun.com | 需要登录 |
| 阿里云 | https://xxx.mirror.aliyuncs.com | 需要注册获取专属地址 |

## 方案二：搭建私有Docker Registry代理

### 2.1 使用Docker Registry作为代理

#### 创建代理配置
```yaml
# docker-compose.yml
version: '3.8'

services:
  registry-proxy:
    image: registry:2
    container_name: docker-registry-proxy
    restart: always
    ports:
      - "5000:5000"
    environment:
      - REGISTRY_PROXY_REMOTEURL=https://registry-1.docker.io
      - REGISTRY_STORAGE_CACHE_BLOBDESCRIPTOR=inmemory
    volumes:
      - ./data:/var/lib/registry
      - ./config.yml:/etc/docker/registry/config.yml
    networks:
      - registry-net

networks:
  registry-net:
    driver: bridge
```

#### 创建Registry配置文件
```yaml
# config.yml
version: 0.1
log:
  fields:
    service: registry
storage:
  cache:
    blobdescriptor: inmemory
  filesystem:
    rootdirectory: /var/lib/registry
http:
  addr: :5000
  headers:
    X-Content-Type-Options: [nosniff]
proxy:
  remoteurl: https://registry-1.docker.io
  username: your-dockerhub-username  # 可选
  password: your-dockerhub-password  # 可选
```

#### 启动代理服务
```bash
# 创建目录
mkdir -p docker-registry-proxy/{data,logs}
cd docker-registry-proxy

# 创建配置文件
cat > config.yml << 'EOF'
version: 0.1
log:
  level: info
  fields:
    service: registry
storage:
  cache:
    blobdescriptor: inmemory
  filesystem:
    rootdirectory: /var/lib/registry
http:
  addr: :5000
proxy:
  remoteurl: https://registry-1.docker.io
EOF

# 启动服务
docker-compose up -d

# 查看日志
docker-compose logs -f registry-proxy
```

### 2.2 配置客户端使用代理

```bash
# 配置Docker使用本地代理
cat > /etc/docker/daemon.json << 'EOF'
{
  "registry-mirrors": [
    "http://localhost:5000"
  ],
  "insecure-registries": [
    "localhost:5000"
  ]
}
EOF

# 重启Docker
sudo systemctl restart docker

# 测试拉取镜像
docker pull localhost:5000/library/nginx:latest
```

## 方案三：使用Nginx作为HTTP代理

### 3.1 Nginx配置

```nginx
# /etc/nginx/conf.d/docker-proxy.conf
upstream docker_registry {
    server registry-1.docker.io:443;
}

server {
    listen 80;
    server_name docker-proxy.yourdomain.com;
    
    # 重定向到HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name docker-proxy.yourdomain.com;
    
    # SSL配置
    ssl_certificate /path/to/your/cert.pem;
    ssl_certificate_key /path/to/your/key.pem;
    
    # 代理配置
    location / {
        proxy_pass https://docker_registry;
        proxy_set_header Host registry-1.docker.io;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 缓存配置
        proxy_cache docker_cache;
        proxy_cache_valid 200 302 24h;
        proxy_cache_valid 404 1m;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        
        # 超时配置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # 缓冲配置
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;
    }
}

# 缓存配置
proxy_cache_path /var/cache/nginx/docker levels=1:2 keys_zone=docker_cache:10m max_size=10g inactive=60m use_temp_path=off;
```

### 3.2 启动Nginx代理

```bash
# 创建缓存目录
sudo mkdir -p /var/cache/nginx/docker
sudo chown nginx:nginx /var/cache/nginx/docker

# 测试配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx

# 配置Docker使用代理
cat > /etc/docker/daemon.json << 'EOF'
{
  "registry-mirrors": [
    "https://docker-proxy.yourdomain.com"
  ]
}
EOF
```

## 方案四：使用Harbor作为企业级代理

### 4.1 安装Harbor

```bash
# 下载Harbor
wget https://github.com/goharbor/harbor/releases/download/v2.7.0/harbor-offline-installer-v2.7.0.tgz
tar xvf harbor-offline-installer-v2.7.0.tgz
cd harbor

# 配置Harbor
cp harbor.yml.tmpl harbor.yml

# 编辑harbor.yml
cat > harbor.yml << 'EOF'
hostname: harbor.yourdomain.com
http:
  port: 80
https:
  port: 443
  certificate: /path/to/cert.crt
  private_key: /path/to/private.key

harbor_admin_password: your_admin_password
database:
  password: your_db_password
data_volume: /data

# 代理配置
proxy:
  http_proxy: http://proxy.yourdomain.com:8080
  https_proxy: http://proxy.yourdomain.com:8080
  no_proxy: localhost,127.0.0.1,.yourdomain.com
EOF

# 安装Harbor
sudo ./install.sh --with-notary --with-trivy --with-chartmuseum
```

### 4.2 配置Harbor代理缓存

```bash
# 在Harbor Web界面中配置代理缓存
# 1. 登录Harbor管理界面
# 2. 进入"仓库管理" -> "代理缓存"
# 3. 创建新的代理缓存项目
# 4. 配置上游仓库为Docker Hub
```

## 方案五：使用Docker代理服务脚本

### 5.1 自动化部署脚本

```bash
#!/bin/bash
# docker-proxy-setup.sh

set -e

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 日志函数
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# 检查Docker是否安装
check_docker() {
    if ! command -v docker &> /dev/null; then
        log_error "Docker未安装，请先安装Docker"
        exit 1
    fi
    log_info "Docker已安装: $(docker --version)"
}

# 配置镜像源
configure_mirrors() {
    log_info "配置Docker镜像源..."
    
    # 备份原配置
    if [ -f /etc/docker/daemon.json ]; then
        sudo cp /etc/docker/daemon.json /etc/docker/daemon.json.backup
        log_info "已备份原配置文件"
    fi
    
    # 创建新配置
    sudo tee /etc/docker/daemon.json > /dev/null <<EOF
{
  "registry-mirrors": [
    "https://docker.mirrors.ustc.edu.cn",
    "https://hub-mirror.c.163.com",
    "https://mirror.baidubce.com"
  ],
  "insecure-registries": [],
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  }
}
EOF
    
    log_info "配置文件已更新"
}

# 重启Docker服务
restart_docker() {
    log_info "重启Docker服务..."
    sudo systemctl daemon-reload
    sudo systemctl restart docker
    
    if sudo systemctl is-active --quiet docker; then
        log_info "Docker服务重启成功"
    else
        log_error "Docker服务重启失败"
        exit 1
    fi
}

# 验证配置
verify_setup() {
    log_info "验证配置..."
    
    # 检查镜像源配置
    if docker info 2>/dev/null | grep -q "Registry Mirrors"; then
        log_info "镜像源配置成功:"
        docker info 2>/dev/null | grep -A 5 "Registry Mirrors"
    else
        log_warn "镜像源配置可能未生效"
    fi
    
    # 测试拉取镜像
    log_info "测试拉取镜像..."
    if docker pull hello-world:latest; then
        log_info "镜像拉取测试成功"
        docker rmi hello-world:latest >/dev/null 2>&1
    else
        log_error "镜像拉取测试失败"
    fi
}

# 主函数
main() {
    log_info "开始配置Docker镜像代理..."
    
    check_docker
    configure_mirrors
    restart_docker
    verify_setup
    
    log_info "Docker镜像代理配置完成！"
    echo
    echo "现在你可以正常使用docker pull命令，镜像将从国内源下载，速度会大大提升。"
}

# 运行主函数
main "$@"
```

### 5.2 使用脚本

```bash
# 下载并执行脚本
curl -fsSL https://raw.githubusercontent.com/your-repo/docker-proxy-setup.sh | bash

# 或者手动执行
chmod +x docker-proxy-setup.sh
./docker-proxy-setup.sh
```

## 性能优化建议

### 1. 缓存策略
```bash
# 配置Docker客户端缓存
export DOCKER_BUILDKIT=1
export BUILDKIT_PROGRESS=plain

# 使用多阶段构建减少镜像大小
FROM node:16-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

FROM node:16-alpine
WORKDIR /app
COPY --from=builder /app/node_modules ./node_modules
COPY . .
EXPOSE 3000
CMD ["npm", "start"]
```

### 2. 网络优化
```bash
# 配置DNS
echo "nameserver 8.8.8.8" | sudo tee -a /etc/resolv.conf
echo "nameserver 114.114.114.114" | sudo tee -a /etc/resolv.conf

# 优化网络参数
echo 'net.core.rmem_default = 262144' | sudo tee -a /etc/sysctl.conf
echo 'net.core.rmem_max = 16777216' | sudo tee -a /etc/sysctl.conf
sudo sysctl -p
```

### 3. 监控脚本
```bash
#!/bin/bash
# monitor-docker-proxy.sh

# 检查代理服务状态
check_proxy_status() {
    local proxy_url="$1"
    local response=$(curl -s -o /dev/null -w "%{http_code}" "$proxy_url/v2/")
    
    if [ "$response" = "200" ]; then
        echo "✅ 代理服务 $proxy_url 正常"
        return 0
    else
        echo "❌ 代理服务 $proxy_url 异常 (HTTP: $response)"
        return 1
    fi
}

# 测试镜像拉取速度
test_pull_speed() {
    local image="nginx:alpine"
    echo "测试拉取镜像: $image"
    
    # 删除本地镜像
    docker rmi "$image" 2>/dev/null || true
    
    # 计时拉取
    local start_time=$(date +%s)
    if docker pull "$image" >/dev/null 2>&1; then
        local end_time=$(date +%s)
        local duration=$((end_time - start_time))
        echo "✅ 镜像拉取成功，耗时: ${duration}秒"
        
        # 清理测试镜像
        docker rmi "$image" >/dev/null 2>&1
    else
        echo "❌ 镜像拉取失败"
    fi
}

# 主监控函数
main() {
    echo "=== Docker代理服务监控 ==="
    echo "时间: $(date)"
    echo
    
    # 检查镜像源配置
    echo "当前配置的镜像源:"
    docker info 2>/dev/null | grep -A 10 "Registry Mirrors" || echo "未配置镜像源"
    echo
    
    # 测试拉取速度
    test_pull_speed
    echo
    
    echo "=== 监控完成 ==="
}

main "$@"
```

## 故障排除

### 常见问题和解决方案

#### 1. 配置不生效
```bash
# 检查配置文件
cat /etc/docker/daemon.json

# 检查Docker状态
sudo systemctl status docker

# 查看Docker日志
sudo journalctl -u docker.service -f
```

#### 2. 镜像拉取失败
```bash
# 测试网络连通性
curl -I https://docker.mirrors.ustc.edu.cn

# 手动指定镜像源
docker pull docker.mirrors.ustc.edu.cn/library/nginx:latest

# 查看详细错误信息
docker pull nginx:latest --verbose
```

#### 3. 代理服务异常
```bash
# 检查代理容器状态
docker ps -a | grep registry

# 查看代理容器日志
docker logs registry-proxy

# 重启代理服务
docker-compose restart registry-proxy
```

## 总结

### 推荐方案选择

1. **个人开发者**：使用方案一（国内镜像源），简单有效
2. **小团队**：使用方案二（私有Registry代理），可控性强
3. **企业用户**：使用方案四（Harbor），功能完整，适合生产环境

### 最佳实践

1. **多镜像源配置**：配置多个镜像源作为备份
2. **定期维护**：定期清理缓存和无用镜像
3. **监控告警**：设置代理服务监控和告警
4. **安全配置**：使用HTTPS和认证机制
5. **文档记录**：记录配置变更和故障处理过程

通过以上方案，可以显著提升Docker镜像下载速度，解决网络访问慢的问题。

---

**创建时间**: 2025-06-29 13:55  
**问题**: 如何搭建一个docker镜像代理服务 我的目的是解决直接从docker上下载镜像慢的问题 